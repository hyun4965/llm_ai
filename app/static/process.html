<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì½˜í…ì¸  ìƒì„±</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* [ê³µí†µ ë³€ìˆ˜] */
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --danger-color: #ef4444;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #e5e7eb;
            --arrow-color: #cbd5e1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: var(--card-bg);
            width: 100%;
            max-width: 500px;
            /* result.html ë„ˆë¹„ì— ë§ì¶¤ */
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        /* --- [í˜ì´ì§€ 1: ì…ë ¥ í™”ë©´ ìŠ¤íƒ€ì¼] --- */
        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 24px;
            text-align: center;
        }

        h1 i {
            color: var(--primary-color);
            margin-right: 8px;
        }

        .input-group {
            margin-bottom: 24px;
            animation: fadeIn 0.5s ease-in-out;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        label i {
            color: var(--primary-color);
            margin-right: 6px;
        }

        /* Select & Input */
        .select-wrapper {
            position: relative;
        }

        select {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: #fff;
            appearance: none;
            cursor: pointer;
            outline: none;
        }

        select:focus {
            border-color: var(--primary-color);
        }

        .select-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-sub);
        }

        textarea {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            height: 120px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            resize: none;
            outline: none;
        }

        textarea:focus {
            border-color: var(--primary-color);
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            background: #f9fafb;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        #recordBtn {
            background-color: #e0e7ff;
            color: var(--primary-color);
        }

        #recordBtn.recording {
            background-color: var(--danger-color);
            color: white;
            animation: pulse 1.5s infinite;
        }

        #submitBtn {
            background: linear-gradient(135deg, var(--primary-color), #6366f1);
            color: white;
            margin-top: 12px;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .helper-text {
            font-size: 13px;
            color: var(--text-sub);
            margin-bottom: 12px;
        }

        #status {
            margin-top: 16px;
            font-size: 14px;
            text-align: center;
            color: var(--primary-color);
            font-weight: 500;
            min-height: 20px;
        }

        /* --- [í˜ì´ì§€ 2: ê²°ê³¼ í™”ë©´ ìŠ¤íƒ€ì¼ (Result.html ë””ìì¸)] --- */
        .step-box {
            position: relative;
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 24px;
            transition: all 0.2s;
        }

        .step-box:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }

        .step-label {
            display: inline-flex;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            margin-bottom: 10px;
        }

        .label-orig {
            background: #f3f4f6;
            color: #374151;
        }

        .label-trans {
            background: #e0e7ff;
            color: #4338ca;
        }

        .label-check {
            background: #fff1f2;
            color: #be123c;
        }

        .text-content {
            font-size: 1.05rem;
            line-height: 1.5;
            color: var(--text-main);
            word-break: keep-all;
        }

        .arrow-down {
            text-align: center;
            color: var(--arrow-color);
            font-size: 1.2rem;
            margin: -15px 0 10px 0;
            font-weight: bold;
        }

        .audio-wrapper {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            text-align: center;
        }

        audio {
            width: 100%;
            height: 40px;
        }

        /* ìœ í‹¸ë¦¬í‹° */
        .hidden {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>

<body>
    <div class="container">

        <div id="view-input">
            <h1 id="mode-title"><i class="fa-solid fa-wand-magic-sparkles"></i>ê¸°ëŠ¥ ìˆ˜í–‰</h1>

            <div class="input-group">
                <label><i class="fa-solid fa-language"></i>ë³€í™˜í•  ì–¸ì–´ ì„ íƒ</label>
                <div class="select-wrapper">
                    <select id="target-lang">
                        <option value="English">ğŸ‡ºğŸ‡¸ English (ì˜ì–´)</option>
                        <option value="Japanese">ğŸ‡¯ğŸ‡µ Japanese (ì¼ë³¸ì–´)</option>
                        <option value="Chinese">ğŸ‡¨ğŸ‡³ Chinese (ì¤‘êµ­ì–´)</option>
                        <option value="Korean">ğŸ‡°ğŸ‡· Korean (í•œêµ­ì–´)</option>

                        <option value="Spanish">ğŸ‡ªğŸ‡¸ Spanish (ìŠ¤í˜ì¸ì–´)</option>
                        <option value="French">ğŸ‡«ğŸ‡· French (í”„ë‘ìŠ¤ì–´)</option>
                        <option value="German">ğŸ‡©ğŸ‡ª German (ë…ì¼ì–´)</option>
                        <option value="Italian">ğŸ‡®ğŸ‡¹ Italian (ì´íƒˆë¦¬ì•„ì–´)</option>
                        <option value="Portuguese">ğŸ‡µğŸ‡¹ Portuguese (í¬ë¥´íˆ¬ê°ˆì–´)</option>
                        <option value="Russian">ğŸ‡·ğŸ‡º Russian (ëŸ¬ì‹œì•„ì–´)</option>
                        <option value="Dutch">ğŸ‡³ğŸ‡± Dutch (ë„¤ëœë€ë“œì–´)</option>
                        <option value="Polish">ğŸ‡µğŸ‡± Polish (í´ë€ë“œì–´)</option>
                        <option value="Turkish">ğŸ‡¹ğŸ‡· Turkish (íŠ€ë¥´í‚¤ì˜ˆì–´)</option>
                        <option value="Swedish">ğŸ‡¸ğŸ‡ª Swedish (ìŠ¤ì›¨ë´ì–´)</option>
                        <option value="Greek">ğŸ‡¬ğŸ‡· Greek (ê·¸ë¦¬ìŠ¤ì–´)</option>

                        <option value="Vietnamese">ğŸ‡»ğŸ‡³ Vietnamese (ë² íŠ¸ë‚¨ì–´)</option>
                        <option value="Indonesian">ğŸ‡®ğŸ‡© Indonesian (ì¸ë„ë„¤ì‹œì•„ì–´)</option>
                        <option value="Thai">ğŸ‡¹ğŸ‡­ Thai (íƒœêµ­ì–´)</option>
                        <option value="Hindi">ğŸ‡®ğŸ‡³ Hindi (íŒë””ì–´)</option>
                        <option value="Arabic">ğŸ‡¸ğŸ‡¦ Arabic (ì•„ëì–´)</option>
                    </select>
                    <div class="select-arrow"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
            </div>

            <div class="input-group">
                <label><i class="fa-solid fa-book-open"></i>ë„ë©”ì¸ ì§€ì‹ ì°¸ê³  (ì„ íƒ)</label>
                <div class="select-wrapper">
                    <select id="domain-select">
                        <option value="none" selected>ì—†ìŒ</option>
                        <option value="ai">ğŸ¤– IT / AI ì „ë¬¸ ì§€ì‹</option>
                        <option value="clothing">ğŸ‘• ì˜ë¥˜ / íŒ¨ì…˜ ì§€ì‹</option>
                        <option value="database">ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤</option>
                        <option value="cloud">â˜ï¸ í´ë¼ìš°ë“œ</option>
                    </select>
                    <div class="select-arrow"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
            </div>

            <div id="record-area" class="input-group hidden">
                <label><i class="fa-solid fa-microphone-lines"></i>ìŒì„± ë…¹ìŒ</label>
                <p class="helper-text">ëª©ì†Œë¦¬ë¥¼ 10ì´ˆ ë‚´ì™¸ë¡œ ì„ ëª…í•˜ê²Œ ë…¹ìŒí•´ ì£¼ì„¸ìš”.</p>
                <button id="recordBtn" class="btn">
                    <i class="fa-solid fa-microphone"></i> <span>ë…¹ìŒ ì‹œì‘</span>
                </button>
            </div>

            <div id="upload-area" class="input-group hidden">
                <label><i class="fa-solid fa-cloud-arrow-up"></i>ìŒì„± íŒŒì¼ ì—…ë¡œë“œ</label>
                <input type="file" id="audio-file" accept="audio/*">
            </div>

            <div id="text-area" class="input-group hidden">
                <label><i class="fa-solid fa-keyboard"></i>í…ìŠ¤íŠ¸ ì…ë ¥</label>
                <textarea id="text-input" placeholder="AIê°€ ë³€í™˜í•  ëŒ€ë³¸ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>

            <div id="status"></div>
            <button id="submitBtn" class="btn">
                <span>AI ì½˜í…ì¸  ìƒì„± ì‹œì‘</span> <i class="fa-solid fa-rocket"></i>
            </button>
        </div>

        <div id="view-result" class="hidden">
            <div style="text-align: center; margin-bottom: 30px;">
                <span style="font-size: 2rem;">ğŸ‰</span>
                <h1>ê²°ê³¼ ë¦¬í¬íŠ¸</h1>
            </div>

            <div class="step-box">
                <span class="step-label label-orig">1. ì›ë³¸ (Original)</span>
                <div id="res-source" class="text-content">ë¡œë”© ì¤‘...</div>
            </div>

            <div class="arrow-down">â†“</div>

            <div class="step-box" style="border-color: #818cf8; background-color: #f5f7ff;">
                <span id="target-badge" class="step-label label-trans">2. ë²ˆì—­ ê²°ê³¼</span>
                <div id="res-translated" class="text-content" style="font-weight: 600;">ë¡œë”© ì¤‘...</div>
            </div>

            <div class="arrow-down">â†“</div>

            <div class="step-box">
                <span class="step-label label-check">3. ì˜ë¯¸ í™•ì¸ (Back-Translation)</span>
                <div id="res-check" class="text-content" style="color: #4b5563;">ê²€ì¦ ìƒëµ</div>
                <p style="font-size: 0.75rem; color: #9ca3af; margin-top:8px;">* ë²ˆì—­ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í•œêµ­ì–´ë¡œ ì§ì—­í•œ ë‚´ìš©ì…ë‹ˆë‹¤.</p>
            </div>

            <div class="audio-wrapper">
                <div style="font-size:0.9rem; font-weight:600; margin-bottom:8px;">ğŸ§ AI ëª©ì†Œë¦¬ ë“£ê¸°</div>
                <audio id="result-audio" controls autoplay></audio>
            </div>

            <button onclick="location.reload()" class="btn" style="margin-top:20px;">
                <i class="fa-solid fa-rotate-left"></i> ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>

    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'text';

        const viewInput = document.getElementById('view-input');
        const viewResult = document.getElementById('view-result');
        const statusEl = document.getElementById('status');
        const modeTitle = document.getElementById('mode-title');

        // [UI ì´ˆê¸°í™”]
        if (mode === 'record') {
            document.getElementById('record-area').classList.remove('hidden');
            modeTitle.innerHTML = '<i class="fa-solid fa-microphone-lines"></i> ìŒì„± ë³µì œ ë° ë²ˆì—­';
        } else if (mode === 'upload') {
            document.getElementById('upload-area').classList.remove('hidden');
            modeTitle.innerHTML = '<i class="fa-solid fa-file-audio"></i> ì˜¤ë””ì˜¤ ë²ˆì—­';
        } else {
            document.getElementById('text-area').classList.remove('hidden');
            modeTitle.innerHTML = '<i class="fa-solid fa-keyboard"></i> í…ìŠ¤íŠ¸ ìŒì„± ë³€í™˜';
        }

        // [ë…¹ìŒ ë¡œì§]
        let mediaRecorder;
        let audioChunks = [];
        const recordBtn = document.getElementById('recordBtn');

        if (recordBtn) {
            recordBtn.onclick = async () => {
                if (!recordBtn.classList.contains("recording")) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                        mediaRecorder.start();

                        recordBtn.classList.add("recording");
                        recordBtn.querySelector('span').textContent = "ë…¹ìŒ ì¤‘ì§€";
                        recordBtn.querySelector('i').className = "fa-solid fa-stop";
                        statusEl.textContent = "ğŸ™ï¸ ë…¹ìŒ ì¤‘...";
                    } catch (err) { alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."); }
                } else {
                    mediaRecorder.stop();
                    recordBtn.classList.remove("recording");
                    recordBtn.querySelector('span').textContent = "ë‹¤ì‹œ ë…¹ìŒí•˜ê¸°";
                    recordBtn.querySelector('i').className = "fa-solid fa-rotate-right";
                    statusEl.textContent = "ë…¹ìŒ ì™„ë£Œ";
                }
            };
        }

        // [í•µì‹¬] ì„œë²„ ìš”ì²­ ë° ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
        document.getElementById('submitBtn').onclick = async () => {
            const lang = document.getElementById('target-lang').value;
            const domain = document.getElementById('domain-select').value;
            if (!lang) return alert("ì–¸ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");

            const formData = new FormData();
            formData.append("target_lang", lang);
            formData.append("mode", mode);
            formData.append("domain", domain);

            if (mode === 'record') {
                if (audioChunks.length === 0) return alert("ë¨¼ì € ë…¹ìŒì„ ì§„í–‰í•´ ì£¼ì„¸ìš”!");
                formData.append("audio", new Blob(audioChunks, { type: 'audio/webm' }), "record.webm");
            } else if (mode === 'upload') {
                const file = document.getElementById('audio-file').files[0];
                if (!file) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");
                formData.append("audio", file);
            } else {
                const text = document.getElementById('text-input').value;
                if (!text) return alert("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
                formData.append("text", text);
            }

            statusEl.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> AIê°€ ìƒê°í•˜ê³  ìˆì–´ìš”... (ë²ˆì—­ ê²€ì¦ ì¤‘)';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').style.opacity = "0.7";

            try {
                const response = await fetch("/api/generate-content", { method: "POST", body: formData });

                if (!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");

                // 1. í—¤ë” ë°ì´í„° ì½ê¸° (ì—­ë²ˆì—­ ë°ì´í„° í¬í•¨)
                const sourceText = decodeURIComponent(response.headers.get("X-Source-Text") || "");
                const translatedText = decodeURIComponent(response.headers.get("X-Translated-Text") || "");
                // ì—­ë²ˆì—­ í—¤ë” ì½ê¸°
                const backTranslatedText = decodeURIComponent(response.headers.get("X-Back-Translated-Text") || "ê²€ì¦ ë°ì´í„° ì—†ìŒ");

                // 2. ì˜¤ë””ì˜¤ Blob ìˆ˜ì‹ 
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                // 3. í™”ë©´ ì „í™˜
                viewInput.classList.add('hidden');
                viewResult.classList.remove('hidden');

                // 4. ë°ì´í„° ë°”ì¸ë”©
                document.getElementById('res-source').innerText = sourceText;
                document.getElementById('res-translated').innerText = translatedText;

                //ì—­ë²ˆì—­ ê²°ê³¼ í‘œì‹œ
                document.getElementById('res-check').innerText = backTranslatedText;
                document.getElementById('target-badge').innerText = `2. ë²ˆì—­ ê²°ê³¼ (${lang})`;

                const audioEl = document.getElementById('result-audio');
                audioEl.src = audioUrl;
                try { await audioEl.play(); } catch (e) { console.log("ìë™ì¬ìƒ ê¶Œí•œ í•„ìš”"); }

            } catch (e) {
                statusEl.innerHTML = `<span style="color:var(--danger-color)">ì˜¤ë¥˜: ${e.message}</span>`;
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').style.opacity = "1";
            }
        };
    </script>
</body>

</html>